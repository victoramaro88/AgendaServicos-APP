<app-menu></app-menu>

<div *ngIf="boolLoading" class="text-center">
  <p-progressBar mode="indeterminate"></p-progressBar>
  <b><p>CARREGANDO...</p></b>
</div>
<p-blockUI [blocked]="boolLoading"></p-blockUI>
<p-toast  position="top-center"></p-toast>

<h1>Usuários</h1>

<!-- LISTANDO NA GRID -->
<div *ngIf="!modoEdicao && listaUsuario.length > 0">
  <p-table #dt1
  [value]="listaUsuario"
  styleClass="p-datatable-striped p-datatable-sm"
  [paginator]="true" [rows]="10"
  [globalFilterFields]="['usuNome','usuLogin']"
  >
  <ng-template pTemplate="caption">
    <div class="p-d-flex text-right">
      <span class="mb-3">
        <button (click)="NovoRegistro()" pButton pRipple pTooltip="Novo Registro" tooltipPosition="left" type="button" label="Novo" class="p-button-raised"></button>
      </span>
      &nbsp;
      <span class="p-input-icon-left p-ml-auto">
        <i class="pi pi-search"></i>
        <input #Filtro pInputText type="text" (input)="dt1.filterGlobal(Filtro.value, 'contains')" placeholder="Pesquisa Global" class="p-inputtext-sm"/>
      </span>
    </div>
  </ng-template>
  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="usuNome">Nome <p-sortIcon field="usuNome"></p-sortIcon></th>
      <th pSortableColumn="usuLogin">Login <p-sortIcon field="usuLogin"></p-sortIcon></th>
      <th pSortableColumn="perfCod">Perfil <p-sortIcon field="perfCod"></p-sortIcon></th>
      <th pSortableColumn="usuStatus">Status <p-sortIcon field="usuStatus"></p-sortIcon></th>
      <th>Ações</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-item>
    <tr>
      <td><span class="p-column-title"><b>Nome</b></span>{{item.usuNome}}</td>
      <td><span class="p-column-title"><b>Login</b></span>{{item.usuLogin}}</td>
      <td><span class="p-column-title"><b>Perfil</b></span>{{SelecionaPerfil(item.perfCod)}}</td>
      <td><span class="p-column-title"><b>Status</b></span>
        <p-tag severity="{{item.usuStatus ? 'success' : 'danger'}}" value="{{item.usuStatus ? 'Ativo' : 'Inativo'}}"></p-tag>
      </td>
      <td>
        <span class="p-column-title"><b>Ações</b></span>
        <div>
          <button (click)="IniciaEdicao(item);" pTooltip="Editar" tooltipPosition="top" pButton pRipple type="button" icon="pi pi-pencil" class="p-button-rounded p-button-info p-button-text"></button>
          <button (click)="AlteraStatusUsuario(item); item.usuStatus = !item.usuStatus;" *ngIf="item.usuStatus" pTooltip="Desativar" tooltipPosition="top" pButton pRipple type="button" icon="pi pi-lock" class="p-button-rounded p-button-success p-button-text"></button>
          <button (click)="AlteraStatusUsuario(item); item.usuStatus = !item.usuStatus;" *ngIf="!item.usuStatus" pTooltip="Ativar" tooltipPosition="top" pButton pRipple type="button" icon="pi pi-lock-open" class="p-button-rounded p-button-danger p-button-text"></button>
        </div>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="emptymessage">
    <tr>
      <td style="text-align: center;" colspan="6">Sem informações.</td>
    </tr>
  </ng-template>
</p-table>
</div>

<!-- MODO INCLUSÃO/ALTERAÇÃO -->
<div *ngIf="modoEdicao" class="card">
  <div class="formgrid grid">
    <div class="field col-12 lg:col-4 md:col-4 sm:col-6">
      <label for="usuNome">Nome</label><span class="campoObrigatorio">*</span>
      <input [(ngModel)]="objUsuario.usuNome" id="usuNome" type="text" class="p-inputtext-sm inputfield w-full" pInputText>
    </div>
    <div class="field col-12 lg:col-3 md:col-4 sm:col-6">
      <label for="usuLogin">Login</label><span class="campoObrigatorio">*</span>
      <input (focusout)="VerificaLogin(objUsuario.usuLogin);" [ngClass]="{'ng-invalid ng-dirty':boolLoginValido}" [(ngModel)]="objUsuario.usuLogin" id="usuLogin" type="text" class="p-inputtext-sm inputfield w-full" pInputText>
      <br><span style="color: red;" class="ml-2" *ngIf="boolLoginValido"><b><small>Login já existe, insira outro!</small></b></span>
    </div>
    <div class="field col-12 lg:col-2 md:col-4 sm:col-5">
      <label for="diamCod">Perfil</label><span class="campoObrigatorio">*</span><br>
      <p-dropdown id="diamCod" [options]="listaPerfil" [(ngModel)]="objUsuario.perfCod" autoWidth="false" [style]="{'width':'100%'}" class="p-inputtext-sm inputfield w-full" optionLabel="perfDesc" optionValue="perfCod" placeholder="Selecione um perfil" [showClear]="true"></p-dropdown>
    </div>
    <div class="field col-12 lg:col-3 md:col-4 sm:col-3">
      <label for="usuStatus">Status</label><span class="campoObrigatorio">*</span>
      <p-selectButton [options]="opcoesStatus" [(ngModel)]="objUsuario.usuStatus" optionLabel="label" optionValue="value"></p-selectButton>
    </div>
    <!-- ALTERAR A SENHA -->
    <div class="field col-12 lg:col-3 md:col-4 sm:col-3">
      <button *ngIf="!boolAlterarSenha && objUsuario.usuCod > 0" (click)="boolAlterarSenha = !boolAlterarSenha;" pButton pRipple type="button" label="Alterar Senha" class="p-button-raised p-button-warning"></button>
      <button *ngIf="boolAlterarSenha && objUsuario.usuCod > 0" (click)="boolAlterarSenha = !boolAlterarSenha; confirmaSenha = ''; objUsuario.usuSenha = '';" pButton pRipple type="button" label="Cancelar Senha" class="p-button-raised p-button-warning"></button>
    </div>
    <div *ngIf="boolAlterarSenha || objUsuario.usuCod === 0" class="field col-12">
      <div class="grid">
        <div class="field col-12 lg:col-3 md:col-4 sm:col-4">
          <label for="usuSenha">Senha</label><span class="campoObrigatorio">*</span>
          <br><p-password [ngClass]="{'ng-invalid ng-dirty':!boolConfirmaSenha}" (keyup)="ValidaSenha();" [(ngModel)]="objUsuario.usuSenha" [toggleMask]="true" class="p-inputtext-sm inputfield w-full"></p-password>
          <br><span style="color: red;" class="ml-2" *ngIf="!boolConfirmaSenha"><b><small>Senhas não conferem!</small></b></span>
        </div>
        <div class="field col-12 lg:col-3 md:col-4 sm:col-4">
          <label for="usuConfirmSenha">Confirme a senha</label><span class="campoObrigatorio">*</span>
          <br><p-password [ngClass]="{'ng-invalid ng-dirty':!boolConfirmaSenha}" (keyup)="ValidaSenha();" [(ngModel)]="confirmaSenha" [toggleMask]="true" class="p-inputtext-sm inputfield w-full"></p-password>
          <br><span style="color: red;" class="ml-2" *ngIf="!boolConfirmaSenha"><b><small>Senhas não conferem!</small></b></span>
        </div>
      </div>
    </div>
  </div>
  <div class="text-right">
    <small><span class="campoObrigatorio">*</span> Campos obrigarórios.</small><br><br>
    <button (click)="Cancelar();" pButton pRipple type="button" label="Cancelar" class="p-button-raised p-button-danger"></button> &nbsp;
    <button (click)="Salvar();" pButton pRipple type="button" label="Salvar" class="p-button-raised p-button-success"></button>
  </div>
</div>
